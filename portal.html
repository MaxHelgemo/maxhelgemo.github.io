<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Portal</title>
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="icon" type="img/png" href="images/favicon.png">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://unpkg.com/draggabilly@3/dist/draggabilly.pkgd.min.js"></script>
    </head>

    <body>
        <main class="portal-main portal-calendar-main">
            <nav class="portal-calendar-nav" id="portal-calendar-nav" aria-label="Pick a month"></nav>
            <div id="portal-root"></div>
        </main>

        <script>
            let portalPairs = [];

            function formatDateLabel(isoDate) {
                if (!isoDate) return "";
                const [y, m, d] = isoDate.split("-");
                const date = new Date(Number(y), Number(m) - 1, Number(d));
                return date.toLocaleDateString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric"
                });
            }

            function getYearMonth(isoDate) {
                if (!isoDate) return "";
                return isoDate.slice(0, 7);
            }

            function getMonthsWithPairs(pairs) {
                const set = new Set();
                pairs.forEach(p => set.add(getYearMonth(p.date)));
                return Array.from(set).sort((a, b) => b.localeCompare(a));
            }

            function renderCalendarNav(months, selectedKey) {
                const nav = document.getElementById("portal-calendar-nav");
                if (!nav) return;
                nav.innerHTML = "";
                const allBtn = document.createElement("button");
                allBtn.type = "button";
                allBtn.className = "portal-calendar-btn" + (selectedKey === "all" ? " is-selected" : "");
                allBtn.textContent = "All";
                allBtn.dataset.filter = "all";
                allBtn.addEventListener("click", () => { setFilter("all"); renderPortalPairs("all"); });
                nav.appendChild(allBtn);
                months.forEach(ym => {
                    const [y, m] = ym.split("-");
                    const date = new Date(Number(y), Number(m) - 1, 1);
                    const label = date.toLocaleDateString(undefined, { month: "short", year: "numeric" }).toUpperCase();
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "portal-calendar-btn" + (selectedKey === ym ? " is-selected" : "");
                    btn.textContent = label;
                    btn.dataset.filter = ym;
                    btn.addEventListener("click", () => { setFilter(ym); renderPortalPairs(ym); });
                    nav.appendChild(btn);
                });
            }

            let currentFilter = "all";
            function setFilter(key) {
                currentFilter = key;
                renderCalendarNav(getMonthsWithPairs(portalPairs), key);
            }

            function renderPortalPairs(filterKey) {
                const root = document.getElementById("portal-root");
                if (!root) return;

                if (!portalPairs.length) {
                    root.innerHTML = "<p class='portal-empty'>No before/after pairs yet.</p>";
                    return;
                }

                let list = [...portalPairs].sort((a, b) => (b.date || "").localeCompare(a.date || ""));
                if (filterKey && filterKey !== "all") {
                    list = list.filter(p => getYearMonth(p.date) === filterKey);
                }

                const frag = document.createDocumentFragment();
                list.forEach(pair => {
                    const article = document.createElement("article");
                    article.className = "portal-pair";

                    const dateSpan = document.createElement("span");
                    dateSpan.className = "portal-date";
                    dateSpan.textContent = formatDateLabel(pair.date);
                    article.appendChild(dateSpan);

                    const imagesWrap = document.createElement("div");
                    imagesWrap.className = "portal-pair-images";
                    const beforeImg = document.createElement("img");
                    beforeImg.src = pair.before;
                    beforeImg.alt = "Before";
                    imagesWrap.appendChild(beforeImg);
                    const afterImg = document.createElement("img");
                    afterImg.src = pair.after;
                    afterImg.alt = "After";
                    imagesWrap.appendChild(afterImg);
                    article.appendChild(imagesWrap);
                    frag.appendChild(article);
                });

                root.innerHTML = "";
                root.appendChild(frag);
            }

            function loadAndRender() {
                fetch("portal-pairs.json")
                    .then((r) => (r.ok ? r.json() : Promise.reject(new Error("Failed to load"))))
                    .then((data) => {
                        portalPairs = data.pairs || [];
                        const months = getMonthsWithPairs(portalPairs);
                        renderCalendarNav(months, "all");
                        renderPortalPairs("all");
                    })
                    .catch(() => {
                        const root = document.getElementById("portal-root");
                        if (root) root.innerHTML = "<p class='portal-empty'>Could not load pairs.</p>";
                    });
            }

            document.addEventListener("DOMContentLoaded", loadAndRender);
        </script>
    </body>
</html>
