<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Portal</title>
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="icon" type="img/png" href="images/favicon.png">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://unpkg.com/draggabilly@3/dist/draggabilly.pkgd.min.js"></script>
    </head>

    <body>
        <main class="portal-main">
            <div id="portal-root"></div>
        </main>

        <script>
            // Pairs are loaded from portal-pairs.json (generated by scripts/generate-portal-pairs.js
            // from the '24 and '25 image folders). Run: node scripts/generate-portal-pairs.js
            let portalPairs = [];

            function formatDateLabel(isoDate) {
                if (!isoDate) return "";
                const [y, m, d] = isoDate.split("-");
                const date = new Date(Number(y), Number(m) - 1, Number(d));
                return date.toLocaleDateString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric"
                });
            }

            function renderPortalPairs() {
                const root = document.getElementById("portal-root");
                if (!root) return;

                if (!portalPairs.length) {
                    root.innerHTML = "<p class='portal-empty'>No before/after pairs yet. Add images (date_1.jpg / date_2.jpg) to the &#39;24 and &#39;25 folders, then run <code>node scripts/generate-portal-pairs.js</code>.</p>";
                    return;
                }

                // Sort newest first by date
                const sorted = [...portalPairs].sort((a, b) => (b.date || "").localeCompare(a.date || ""));

                const frag = document.createDocumentFragment();

                sorted.forEach(pair => {
                    const article = document.createElement("article");
                    article.className = "portal-pair";

                    const dateSpan = document.createElement("span");
                    dateSpan.className = "portal-date";
                    dateSpan.textContent = formatDateLabel(pair.date);
                    article.appendChild(dateSpan);

                    const imagesWrap = document.createElement("div");
                    imagesWrap.className = "portal-pair-images";

                    const beforeImg = document.createElement("img");
                    beforeImg.src = pair.before;
                    beforeImg.alt = "Before";
                    imagesWrap.appendChild(beforeImg);

                    const afterImg = document.createElement("img");
                    afterImg.src = pair.after;
                    afterImg.alt = "After";
                    imagesWrap.appendChild(afterImg);

                    article.appendChild(imagesWrap);
                    frag.appendChild(article);
                });

                root.innerHTML = "";
                root.appendChild(frag);
            }

            function loadAndRender() {
                fetch("portal-pairs.json")
                    .then((r) => (r.ok ? r.json() : Promise.reject(new Error("Failed to load pairs"))))
                    .then((data) => {
                        portalPairs = data.pairs || [];
                        renderPortalPairs();
                    })
                    .catch((err) => {
                        const root = document.getElementById("portal-root");
                        if (root) {
                            root.innerHTML = "<p class='portal-empty'>Could not load before/after pairs. Run <code>node scripts/generate-portal-pairs.js</code> to generate portal-pairs.json.</p>";
                        }
                    });
            }

            document.addEventListener("DOMContentLoaded", loadAndRender);
        </script>

        <script src="init.js"></script>
    </body>
</html>
